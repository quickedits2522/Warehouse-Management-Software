<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profit & Loss Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #b6c7d6 0%, #95e0ea 100%);
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background: #f0f4f8;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    header img {
      height: 50px;
      margin-right: 15px;
      object-fit: contain;
    }

    header h1 {
      font-size: 1.8rem;
      color: #1e3a8a;
      margin: 0;
    }

    .header-right a {
      text-decoration: none;
      color: white;
      background-color: #2563eb;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: 0.3s;
      margin-left: 10px;
    }

    .header-right a:hover {
      background-color: #1d4ed8;
      transform: scale(1.05);
    }

    main {
      padding: 40px 50px;
    }

    h1 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 30px;
    }

    /* Summary Cards */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(203, 228, 233, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .card .emoji {
      font-size: 3rem;
      margin-bottom: 8px;
    }

    .card h2 {
      margin: 10px 0 5px 0;
      color: #1e3a8a;
    }

    .card .value {
      font-size: 2rem;
      font-weight: 600;
      color: #111827;
    }

    /* Export button */
    .export-btn {
      text-align: right;
      margin-bottom: 15px;
    }
    .export-btn button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    .export-btn button:hover {
      background-color: #1d4ed8;
      transform: scale(1.05);
    }

    /* Search box */
    .search-box {
      margin-bottom: 15px;
      text-align: left;
    }
    .search-box input {
      padding: 8px 12px;
      width: 250px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      background: rgba(203, 228, 233, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
      font-family: 'Poppins', sans-serif;
    }

    th, td {
      padding: 12px 15px;
      text-align: center;
    }

    th {
      background-color: #2563eb;
      color: white;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      user-select: none;
    }

    th .arrow {
      font-size: 0.8rem;
      margin-left: 5px;
    }

    th.sorted-asc .arrow::after {
      content: "‚ñ≤";
    }

    th.sorted-desc .arrow::after {
      content: "‚ñº";
    }

    tr:nth-child(even) {
      background-color: rgba(255,255,255,0.6);
    }

    tr:hover {
      background-color: rgba(37, 99, 235, 0.2);
    }

    .profit {
      color: green;
      font-weight: 600;
    }

    .loss {
      color: red;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      main {
        padding: 20px;
      }
      th, td {
        padding: 10px 8px;
      }
      .search-box input {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="header-left">
      <img src="/static/logo.png" alt="Company Logo">
      <h1>{{ company_name }}</h1>
    </div>
    <div class="header-right">
      <a href="/add_order">‚ûï Add Order</a>
      <a href="/">üè† Dashboard</a>
    </div>
  </header>

  <main>
    <h1>Profit & Loss Report</h1>

    <!-- Summary Cards -->
    <div class="cards-container">
      <div class="card">
        <div class="emoji">üí∞</div>
        <h2>Total Net Profit</h2>
        <div class="value">‚Çπ {{ total_net_profit }}</div>
      </div>
      <div class="card">
        <div class="emoji">üßæ</div>
        <h2>Total Bills</h2>
        <div class="value">{{ total_bills }}</div>
      </div>
      <div class="card">
        <div class="emoji">üì¶</div>
        <h2>Total Products</h2>
        <div class="value">{{ total_products }}</div>
      </div>
    </div>

    <!-- Export Button -->
    <div class="export-btn">
      <a href="/export_profit_loss">
        <button>üì• Export to CSV</button>
      </a>
    </div>

    <!-- Search Box -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by Bill or Product..." onkeyup="filterTable()">
    </div>

    <!-- Sortable Table -->
    <div class="table-container">
      <table id="profitLossTable">
        <thead>
          <tr>
            <th onclick="sortTable(0, 'num')">Bill No <span class="arrow">‚¨ç</span></th>
            <th onclick="sortTable(1, 'str')">Product Name <span class="arrow">‚¨ç</span></th>
            <th onclick="sortTable(2, 'num')">Net Profit (‚Çπ) <span class="arrow">‚¨ç</span></th>
          </tr>
        </thead>
        <tbody>
          {% for row in profit_loss_data %}
          <tr>
            <td>{{ row.BillNo }}</td>
            <td>{{ row.Product_Name }}</td>
            <td class="{{ 'profit' if row.Net_Profit >= 0 else 'loss' }}">{{ row.Net_Profit }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <script>
    // Sortable table
    let currentSortCol = -1;
    let currentSortDir = 'asc';

    function sortTable(n, type) {
      const table = document.getElementById("profitLossTable");
      let rows, switching, i, x, y, shouldSwitch;
      switching = true;

      // Remove sort classes from all headers
      Array.from(table.getElementsByTagName('th')).forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
      });

      // Determine sorting direction
      if (currentSortCol === n) {
        currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortDir = 'asc';
      }
      currentSortCol = n;

      // Add class to show arrow
      table.getElementsByTagName('th')[n].classList.add(currentSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');

      while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          x = rows[i].getElementsByTagName("TD")[n];
          y = rows[i + 1].getElementsByTagName("TD")[n];

          let xContent = x.innerText || x.textContent;
          let yContent = y.innerText || y.textContent;

          if (type === 'num') {
            xContent = parseFloat(xContent);
            yContent = parseFloat(yContent);
          }

          if (currentSortDir === "asc") {
            if (xContent > yContent) { shouldSwitch = true; break; }
          } else {
            if (xContent < yContent) { shouldSwitch = true; break; }
          }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
        }
      }
    }

    // Search/Filter Table
    function filterTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const table = document.getElementById("profitLossTable");
      const tr = table.getElementsByTagName("tr");

      for (let i = 1; i < tr.length; i++) {
        let tdBill = tr[i].getElementsByTagName("td")[0];
        let tdProduct = tr[i].getElementsByTagName("td")[1];
        if (tdBill && tdProduct) {
          let txtValueBill = tdBill.textContent || tdBill.innerText;
          let txtValueProduct = tdProduct.textContent || tdProduct.innerText;
          if (txtValueBill.toLowerCase().indexOf(filter) > -1 ||
              txtValueProduct.toLowerCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }
  </script>

</body>
</html>
